

[virtual_sdcard]
path: ~/gcode_files

[display_status]

[pause_resume]
recover_velocity: 50.0

[include timelapse.cfg]

# rezonancija

#[mcu rpi]
#serial: /tmp/klipper_host_mcu

#[adxl345]
#cs_pin: rpi:None

#[resonance_tester]
#accel_chip: adxl345
#probe_points:
#    114,114,20  # an example

[input_shaper]
shaper_freq_x: 49.8
shaper_type_x: mzv
shaper_freq_y: 41.8
shaper_type_y: ei

#shaper_freq_y: 35.2
#shaper_type_y: mzv

#shaper_freq_x: 33.55
#shaper_freq_y: 33.50
#shaper_type: mzv


[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
endstop_pin: ^PA5
rotation_distance: 39.951991
position_endstop: 0
position_max: 253
homing_speed: 80


[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
endstop_pin: ^PA6
position_endstop: 0
rotation_distance: 39.976841
position_min: -22
position_endstop: -22
position_max: 253
homing_speed: 80


[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
microsteps: 16
rotation_distance: 8.006348
endstop_pin: probe:z_virtual_endstop
position_max: 240
homing_speed: 10
position_min: -5



[extruder]
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
heater_pin: PA1
rotation_distance: 7.420311
#rotation_distance: 7.630065
nozzle_diameter: 0.400
filament_diameter: 1.750
#pressure_advance: 0.04855
pressure_advance: 0.02855
max_extrude_only_distance: 100
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC5
control: pid
# tuned for stock hardware with 200 degree Celsius target
pid_Kp: 21.527
pid_Ki: 1.063
pid_Kd: 108.982
min_temp: 0
max_temp: 280
max_extrude_only_distance: 120.0 #add this line to your extruder section
min_extrude_temp: 175


[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
control: pid
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182
min_temp: 0
max_temp: 130

[fan]
pin: PA0

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 300
max_z_velocity: 5
max_z_accel: 100
#max_accel: 7000
max_accel: 1000
#max_accel_to_decel: 7000
max_accel_to_decel: 1000
square_corner_velocity: 5


[board_pins]
aliases:
  EXP1_1=PC6,EXP1_3=PB10,EXP1_5=PB14,EXP1_7=PB12,EXP1_9=<GND>,
  EXP1_2=PB2,EXP1_4=PB11,EXP1_6=PB13,EXP1_8=PB15,EXP1_10=<5V>,
  PROBE_IN=PB0,PROBE_OUT=PB1,FIL_RUNOUT=PC6

[bltouch]
sensor_pin: ^PB1
control_pin: PB0
x_offset: -42
y_offset: 1
pin_move_time: 0.675
probe_with_touch_mode: True
speed: 8.0
lift_speed: 20
samples: 6
samples_result: median
pin_up_reports_not_triggered: True
samples_tolerance: 0.010
#samples_tolerance: 0.015
samples_tolerance_retries: 8
stow_on_each_sample: False
sample_retract_dist: 0.8



[safe_z_home]
home_xy_position: 157, 130
speed: 90.0
z_hop: 15.0
z_hop_speed: 20.0

[screws_tilt_adjust]
screw1: 60,30
screw1_name: front left screw
screw2: 240,30
screw2_name: front right screw
screw3: 240,200
screw3_name: rear right screw
screw4: 60,200
screw4_name: rear left screw
horizontal_move_z: 7.
speed: 120
screw_thread: CW-M4

[bed_mesh]
speed: 150
horizontal_move_z: 7
#mesh_min: 40, 30
mesh_min: 10, 10
mesh_max: 209, 210
#probe_count: 5, 5
probe_count: 6, 6
algorithm: bicubic
fade_start: 1
fade_end: 10
fade_target: 0

[filament_motion_sensor FILAMENTS]
detection_length: 65.0
extruder: extruder
switch_pin: PA4
pause_on_runout: True
runout_gcode: 
    PAUSE
pause_delay: 1

[gcode_macro _bot_data]
variable_lapse_video_size: 0
variable_lapse_filename: 'None'
variable_lapse_path: 'None'
gcode:
    M118 Setting bot lapse variables
    

[gcode_macro M600]
gcode:
       PAUSE




[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
gcode:
    ##### set defaults #####
    {% set x = params.X|default(10) %}      #edit to your park position
    {% set y = params.Y|default(10) %}      #edit to your park position
    {% set z = params.Z|default(10)|float %} #edit to your park position
    {% set e = params.E|default(1) %}        #edit to your retract length
    ##### calculate save lift position #####
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% set lift_z = z|abs %}
    {% if act_z < (max_z - lift_z) %}
        {% set z_safe = lift_z %}
    {% else %}
        {% set z_safe = max_z - act_z %}
    {% endif %}
    ##### end of definitions #####
    PAUSE_BASE
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
      G1 E-{e} F2100
    {% else %}
      {action_respond_info("Extruder not hot enough")}
    {% endif %}
    {% if "xyz" in printer.toolhead.homed_axes %}    
      G1 Z{z_safe}
      G90
      G1 X{x} Y{y} F6000
    {% else %}
      {action_respond_info("Printer not homed")}
    {% endif %}


[gcode_macro RESTARTPRINTER]
gcode:
        FIRMWARE_RESTART


   

[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
    ##### set defaults #####
    {% set e = params.E|default(1) %} #edit to your retract length
    #### get VELOCITY parameter if specified ####
    {% if 'VELOCITY' in params|upper %}
      {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
    {%else %}
      {% set get_params = "" %}
    {% endif %}
    ##### end of definitions #####
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
      G1 E{e} F2100
    {% else %}
      {action_respond_info("Extruder not hot enough")}
    {% endif %}  
    RESUME_BASE {get_params}




[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
gcode:
        TURN_OFF_HEATERS
        CLEAR_PAUSE
        G91 ; Set coordinates to relative
        G1 F1800 E-3 ; Retract filament 3 mm to prevent oozing
        G1 F3000 Z20 ; raise head
        G90 ; Set coordinates to absolute
        G1 X10 Y200 F5000.0 ; Move to start position
        M106 S0
        M84
        BED_MESH_PROFILE REMOVE=default
        FIRMWARE_RESTART

[gcode_macro G29]
gcode:
  G28
  BED_MESH_CALIBRATE METHOD=automatic

  

[gcode_macro LOAD_FILAMENT]
gcode:
        SAVE_GCODE_STATE NAME=LOAD_FILAMENT
        M83
        G92 E0.0
        G1 E20 F100
        G92 E0.0
        RESTORE_GCODE_STATE NAME=LOAD_FILAMENT MOVE=1


[gcode_macro UNLOAD_FILAMENT]
gcode:
        SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT
        G1 E0.5 F1000
        G1 E-0.5 F1000
        G1 E1.0 F1000
        G1 E-1.0 F1000
        G1 E1.5 F1000
        G1 E-1.5 F1000
        G1 E2.0 F1000
        G1 E-100 F3000
        G92 E0.0
        RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT MOVE=1

[gcode_macro ALL_HOME]
gcode:
        G28



#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bltouch]
#*# z_offset = 4.575
